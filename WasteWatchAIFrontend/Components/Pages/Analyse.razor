@page "/analyse"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS

@code {
    private string GetFilterSummary()
    {
        var parts = new List<string>();

        // Periode
        if (!string.IsNullOrEmpty(selectedPeriod))
        {
            parts.Add(selectedPeriod switch
            {
                "week" => "de afgelopen week",
                "month" => "de afgelopen maand",
                "year" => "het afgelopen jaar",
                _ => ""
            });
        }
        else
        {
            parts.Add("de volledige periode");
        }

        // Locatie
        if (!string.IsNullOrEmpty(selectedLocation))
            parts.Add($"locatie: {selectedLocation}");
        else
            parts.Add("alle locaties");

        // Categorie
        if (!string.IsNullOrEmpty(selectedCategory))
        {
            var cat = selectedCategory switch
            {
                "plastic" => "Plastic",
                "papier" => "Papier",
                "gft" => "GFT/Organisch",
                "glas" => "Glas",
                _ => selectedCategory
            };
            parts.Add($"categorie: {cat}");
        }
        else
        {
            parts.Add("alle categorieën");
        }

        return string.Join(", ", parts);
    }

    // Models
    public class DummyTrashItem
    {
        public Guid Id { get; set; }
        public string LitterType { get; set; } = string.Empty;
        public float Latitude { get; set; }
        public float Longitude { get; set; }
        public DateTime Timestamp { get; set; }
    }

    public class LocationChartData
    {
        public string LocationName { get; set; } = string.Empty;
        public Dictionary<string, int> TypeCounts { get; set; } = new();
        public int TotalCount { get; set; }
    }

    public class FrequencyDataItem
    {
        public string Label { get; set; } = string.Empty;
        public int Value { get; set; }
        public string Time { get; set; } = string.Empty;
    }

    // State variables
    private List<DummyTrashItem> trashItems = new();
    private List<LocationChartData> locationChartData = new();
    private List<FrequencyDataItem> frequencyData = new();
    private bool isLoading = true;
    private string selectedPeriod = string.Empty;
    private string selectedLocation = string.Empty;
    private string selectedCategory = string.Empty;

    // Define color mapping for waste types
    private readonly Dictionary<string, string> wasteTypeColors = new()
    {
        { "Plastic", "#e74c3c" },      // Red
        { "Papier", "#3498db" },       // Blue
        { "Organisch", "#2ecc71" },    // Green
        { "Glas", "#f39c12" },         // Orange
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadTrashData();
        await ProcessData();
    }

    private async Task LoadTrashData()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("WasteWatchAPI");
            var response = await httpClient.GetAsync("api/dummytrashitems");
            if (response.IsSuccessStatusCode)
            {
                trashItems = await response.Content.ReadFromJsonAsync<List<DummyTrashItem>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading trash data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading)
        {
            await JS.InvokeVoidAsync("eval", @"
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=""tooltip""]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            ");

            // Initialize charts
            await InitializeCharts();
        }
    }

    private async Task InitializeCharts()
    {
        // Initialize type distribution chart
        await InitializeTypeDistributionChart();

        // Initialize frequency chart
        await InitializeFrequencyChart();
    }

    private async Task InitializeTypeDistributionChart()
    {
        if (!locationChartData.Any()) return;

        var locations = locationChartData.Select(l => l.LocationName).ToArray();
        var wasteTypes = GetAllWasteTypes();

        var datasets = wasteTypes.Select(wasteType => new
        {
            label = wasteType,
            data = locationChartData.Select(loc => loc.TypeCounts.GetValueOrDefault(wasteType, 0)).ToArray(),
            backgroundColor = wasteTypeColors.GetValueOrDefault(wasteType, "#95a5a6"),
            borderColor = wasteTypeColors.GetValueOrDefault(wasteType, "#95a5a6"),
            borderWidth = 1
        }).ToArray();

        var chartData = new
        {
            labels = locations,
            datasets = datasets
        };

        await JS.InvokeVoidAsync("initializeTypeDistributionChart", chartData);
    }

    private async Task InitializeFrequencyChart()
    {
        if (!frequencyData.Any()) return;

        var chartData = new
        {
            labels = frequencyData.Select(f => f.Time).ToArray(),
            datasets = new[]
            {
                new
                {
                    label = "Detecties",
                    data = frequencyData.Select(f => f.Value).ToArray(),
                    borderColor = "#4299e1",
                    backgroundColor = "rgba(66, 153, 225, 0.3)",
                    fill = true,
                    tension = 0.4,
                    pointBackgroundColor = "#4299e1",
                    pointBorderColor = "#ffffff",
                    pointBorderWidth = 2,
                    pointRadius = 4
                }
            }
        };

        await JS.InvokeVoidAsync("initializeFrequencyChart", chartData);
    }

    private async Task ProcessData()
    {
        if (!trashItems.Any()) return;

        // Process location-based chart data
        var locationGroups = trashItems
            .GroupBy(item => GetLocationName(item.Latitude, item.Longitude))
            .Select(group => new LocationChartData
                {
                    LocationName = group.Key,
                    TypeCounts = group.GroupBy(item => item.LitterType)
                                                             .ToDictionary(typeGroup => typeGroup.Key, typeGroup => typeGroup.Count()),
                    TotalCount = group.Count()
                })
            .OrderByDescending(loc => loc.TotalCount)
            .Take(5) // Show top 5 locations
            .ToList();

        locationChartData = locationGroups;

        // Process frequency data - count by hour of day
        var hourlyFrequency = new List<FrequencyDataItem>();

        // Create hourly buckets from 06:00 to 22:00
        for (int hour = 6; hour <= 22; hour++)
        {
            var count = trashItems.Count(item => item.Timestamp.Hour == hour);
            hourlyFrequency.Add(new FrequencyDataItem
                {
                    Label = $"{hour:D2}:00",
                    Time = $"{hour:D2}:00",
                    Value = count
                });
        }

        frequencyData = hourlyFrequency;
    }

    private string GetLocationName(float latitude, float longitude)
    {
        // Breda: Grote Markt (updated range)
        if (latitude >= 51.5890 && latitude <= 51.5900 && longitude >= 4.7750 && longitude <= 4.7765)
            return "Grote Markt Breda";

        // Breda: Centraal Station
        if (latitude >= 51.5953 && latitude <= 51.5963 && longitude >= 4.7787 && longitude <= 4.7797)
            return "Centraal Station Breda";

        // Breda: Valkenberg Park
        if (latitude >= 51.5929 && latitude <= 51.5939 && longitude >= 4.7791 && longitude <= 4.7801)
            return "Valkenberg Park";

        // Breda: Haagdijk (updated range)
        if (latitude >= 51.5920 && latitude <= 51.5925 && longitude >= 4.7685 && longitude <= 4.7695)
            return "Haagdijk";

        // Breda: Chassé Park (new)
        if (latitude >= 51.5860 && latitude <= 51.5866 && longitude >= 4.7848 && longitude <= 4.7856)
            return "Chassé Park";

        // Breda: Chasséveld (existing)
        if (latitude >= 51.5890 && latitude <= 51.5902 && longitude >= 4.7750 && longitude <= 4.7766)
            return "Chasséveld";

        // Default locations for other coordinates
        var random = new Random((int)(latitude * 1000 + longitude * 1000));
        var locations = new[] { "Stadspark", "Marktplein", "Winkelcentrum", "Sportpark", "Industrieterrein" };
        return locations[random.Next(locations.Length)];
    }

    private string GetDayAbbreviation(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "Ma",
            DayOfWeek.Tuesday => "Di",
            DayOfWeek.Wednesday => "Wo",
            DayOfWeek.Thursday => "Do",
            DayOfWeek.Friday => "Vr",
            DayOfWeek.Saturday => "Za",
            DayOfWeek.Sunday => "Zo",
            _ => day.ToString()
        };
    }

    private int GetDayOrder(string dayAbbr)
    {
        return dayAbbr switch
        {
            "Ma" => 1,
            "Di" => 2,
            "Wo" => 3,
            "Do" => 4,
            "Vr" => 5,
            "Za" => 6,
            "Zo" => 7,
            _ => 8
        };
    }

    private async Task ApplyFilters()
    {
        var filteredItems = trashItems.AsEnumerable();

        if (!string.IsNullOrEmpty(selectedPeriod))
        {
            var now = DateTime.Now;
            filteredItems = selectedPeriod switch
            {
                "week" => filteredItems.Where(item => item.Timestamp >= now.AddDays(-7)),
                "month" => filteredItems.Where(item => item.Timestamp >= now.AddMonths(-1)),
                "year" => filteredItems.Where(item => item.Timestamp >= now.AddYears(-1)),
                _ => filteredItems
            };
        }

        if (!string.IsNullOrEmpty(selectedCategory))
        {
            var categoryMap = new Dictionary<string, string>
        {
            { "plastic", "Plastic" },
            { "papier", "Papier" },
            { "gft", "Organisch" },
            { "glas", "Glas" }
        };

            if (categoryMap.TryGetValue(selectedCategory, out var actualCategory))
            {
                filteredItems = filteredItems.Where(item =>
                    item.LitterType.Equals(actualCategory, StringComparison.OrdinalIgnoreCase));
            }
        }

        if (!string.IsNullOrEmpty(selectedLocation))
        {
            filteredItems = filteredItems.Where(item =>
                GetLocationName(item.Latitude, item.Longitude).Equals(selectedLocation, StringComparison.OrdinalIgnoreCase));
        }

        var originalItems = trashItems;
        trashItems = filteredItems.ToList();

        await ProcessData();
        trashItems = originalItems;

        StateHasChanged();
        await InitializeCharts();
    }

    // New method for handling filter changes
    private async Task OnFilterChanged()
    {
        await ApplyFilters();
    }

    // New method for resetting filters
    private async Task ResetFilters()
    {
        selectedPeriod = string.Empty;
        selectedLocation = string.Empty;
        selectedCategory = string.Empty;

        await ApplyFilters();
    }

    // Helper method to check if any filters are active
    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(selectedPeriod) ||
               !string.IsNullOrEmpty(selectedLocation) ||
               !string.IsNullOrEmpty(selectedCategory);
    }

    private int GetMaxValueForLocation(LocationChartData location)
    {
        return location.TypeCounts.Values.DefaultIfEmpty(0).Max();
    }

    private List<string> GetAllWasteTypes()
    {
        return locationChartData
            .SelectMany(loc => loc.TypeCounts.Keys)
            .Distinct()
            .OrderBy(type => type)
            .ToList();
    }
}

// Main Content
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="pt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="dashboard" class="text-decoration-none">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Analyse</li>
        </ol>
    </nav>

    <h1 class="h2 mb-4">Datafilters</h1>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Filters Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Datafilters</h5>
                    @if (HasActiveFilters())
                    {
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ResetFilters" title="Alle filters wissen">
                            <i class="fas fa-times me-1"></i>
                            Reset
                        </button>
                    }
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="periode" class="form-label">Periode</label>
                        <select class="form-select" id="periode" @bind="selectedPeriod" @bind:after="OnFilterChanged">
                            <option value="">Selecteer datumbereik</option>
                            <option value="week">Deze week</option>
                            <option value="month">Deze maand</option>
                            <option value="year">Dit jaar</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="locatie" class="form-label">Locatie</label>
                        <select class="form-select" id="locatie" @bind="selectedLocation" @bind:after="OnFilterChanged">
                            <option value="">Kies locatie</option>
                            @foreach (var location in locationChartData.Select(l => l.LocationName).Distinct())
                            {
                                <option value="@location">@location</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="afvalcategorie" class="form-label">Afvalcategorie</label>
                        <select class="form-select" id="afvalcategorie" @bind="selectedCategory" @bind:after="OnFilterChanged">
                            <option value="">Selecteer categorie</option>
                            <option value="plastic">Plastic</option>
                            <option value="papier">Papier</option>
                            <option value="gft">GFT/Organisch</option>
                            <option value="glas">Glas</option>
                        </select>
                    </div>
                </div>
                @if (HasActiveFilters())
                {
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-filter me-1"></i>
                            Actieve filters: @GetFilterSummary()
                        </small>
                    </div>
                }
            </div>
        </div>

        <!-- Data Summary -->
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Totaal @trashItems.Count afvalitems geladen uit de database.
        </div>

        <!-- Chart Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Overzicht afvaldata</h5>

                <!-- Chart Tabs -->
                <ul class="nav nav-tabs chart-tabs mb-3" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="typeverdeling-tab" data-bs-toggle="tab" data-bs-target="#typeverdeling" type="button" role="tab">
                            Afval Typeverdeling per Locatie
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="frequentie-tab" data-bs-toggle="tab" data-bs-target="#frequentie" type="button" role="tab">
                            Frequentie Analyse
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="correlaties-tab" data-bs-toggle="tab" data-bs-target="#correlaties" type="button" role="tab">
                            Correlaties
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="chartTabContent">
                    <div class="tab-pane fade show active" id="typeverdeling" role="tabpanel">
                        <h6 class="mb-3">Afval Typeverdeling per Locatie</h6>
                        <p class="text-muted small mb-3">Analyse van verschillende afvaltypes per locatie</p>
                        <p class="text-muted small mb-2">
                            Data voor: @GetFilterSummary()
                        </p>

                        @if (locationChartData.Any())
                        {
                            <!-- Chart Container -->
                            <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
                                <canvas id="typeDistributionChart"></canvas>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                Geen data beschikbaar voor locatie-analyse.
                            </div>
                        }
                    </div>

                    <div class="tab-pane fade" id="frequentie" role="tabpanel">
                        <div class="frequency-chart-header mb-4">
                            <h6 class="mb-1">Frequentie Analyse</h6>
                            <p class="text-muted small mb-0">Afvaldetecties per tijdstip van de dag</p>
                            <p class="text-muted small mb-2">
                                Data voor: @GetFilterSummary()
                            </p>
                        </div>

                        @if (frequencyData.Any())
                        {
                            <!-- Chart Container -->
                            <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
                                <canvas id="frequencyChart"></canvas>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                Geen data beschikbaar voor frequentieanalyse.
                            </div>
                        }
                    </div>

                    <div class="tab-pane fade" id="correlaties" role="tabpanel">
                        <h6 class="mb-3">Correlatie: Weer & Afval</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Correlatie-analyse wordt geladen...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Insights based on location data -->
        <h5 class="mb-3">Data Inzichten</h5>

        @if (locationChartData.Any())
        {
            var topLocation = locationChartData.First();
            var topWasteType = topLocation.TypeCounts.OrderByDescending(kvp => kvp.Value).First();

            <div class="card mb-3">
                <div class="card-body">
                    <span class="badge insight-badge mb-2">Inzicht</span>
                    <h6 class="card-title">Meest vervuilde locatie</h6>
                    <p class="card-text text-muted">
                        @topLocation.LocationName heeft de meeste afvalmeldingen (@topLocation.TotalCount items),
                        vooral @topWasteType.Key (@topWasteType.Value items).
                    </p>
                </div>
            </div>
        }

        @if (trashItems.Any())
        {
            var recentItems = trashItems.Where(item => item.Timestamp >= DateTime.Now.AddDays(-7)).Count();
            <div class="card mb-4">
                <div class="card-body">
                    <span class="badge insight-badge mb-2">Inzicht</span>
                    <h6 class="card-title">Recente activiteit</h6>
                    <p class="card-text text-muted">
                        In de afgelopen week zijn er @recentItems nieuwe afvalitems geregistreerd.
                    </p>
                </div>
            </div>
        }
    }
</main>

<link href="css/chart.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    let typeDistributionChart = null;
    let frequencyChart = null;

    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    window.initializeTypeDistributionChart = function(chartData) {
        const ctx = document.getElementById('typeDistributionChart');
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (typeDistributionChart) {
            typeDistributionChart.destroy();
        }

        typeDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    };

    window.initializeFrequencyChart = function(chartData) {
        const ctx = document.getElementById('frequencyChart');
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (frequencyChart) {
            frequencyChart.destroy();
        }

        frequencyChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        title: {
                            display: true,
                            text: 'Tijd van de dag'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        title: {
                            display: true,
                            text: 'Aantal detecties'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    };
</script>